---
- name: Provision an S3 bucket
  hosts: localhost
  gather_facts: True

  vars:
    access_key: <%= s3[:aws_access_key] %>
    secret_key: <%= s3[:aws_secret_key] %>
    region: <%= s3[:region] %>

    resource_id: <%= s3[:resource_id] %>
    resource_name: <%= s3[:resource_name] %>
    artifact_path: <%= s3[:artifact_file_path] %>
    tags: <%= s3[:tags] %>

  tasks:

    - name: Provision AWS S3 bucket - "{{ resource_id }}"
      s3_bucket:
         aws_access_key: "{{ access_key }}"
         aws_secret_key: "{{ secret_key }}"
         region: "{{ region }}"
         name: "{{ resource_name }}"
         tags: "{{ tags }}"
         state: present
      register: s3

    - block:
      - name: Create artifact file
        file:
          path: /tmp/var.json
          state: touch

      - name: Load var from file
        include_vars:
          file: /tmp/var.json
          name: temp_json

      - name: Creating artifact JSON key/values
        set_fact:
          artifact_json: "{{ temp_json | default([]) | combine({
            'resource_id': resource_id,
            'params': {
              'url': 'https://{{ resource_name }}.s3.{{ region }}.amazonaws.com'
            }
            })
          }}"

      - name: write var to file
        copy:
          content: "{{ artifact_json | to_nice_json }}"
          dest: "{{ artifact_path }}/artifact.json"
      delegate_to: localhost
